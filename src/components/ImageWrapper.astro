---
import path from "node:path";
import { Image } from "astro:assets";
// 假设这些配置和类型来自您的项目，保持不变
import { devConfig, isDev } from "@/config/dev";

interface Props {
  id?: string;
  src: string;
  class?: string;
  alt?: string;
  caption?: string;
  position?: string;
  basePath?: string;
  width?: number;
  height?: number;
  format?: "webp" | "avif" | "png" | "jpg" | "jpeg" | "svg";
  quality?: number;
  loading?: "lazy" | "eager";
  decoding?: "async" | "sync" | "auto";
  fetchpriority?: "high" | "low" | "auto";
  densities?: number[];
  aspectRatio?: "auto" | "16:9" | "9:16" | "4:3" | "3:4" | "1:1"; // 新增比例选项
  maxWidth?: number; // 新增最大宽度限制
}

const { 
  id, 
  src, 
  alt = "", 
  caption,
  position = "center", 
  basePath = "/",
  width,
  height,
  format = "webp",
  quality = 85,
  loading = "lazy",
  decoding = "async",
  fetchpriority = "auto",
  densities = [1, 2],
  aspectRatio = "auto", // 默认自动检测比例
  maxWidth = 1200 // 默认最大宽度
} = Astro.props;

const className = Astro.props.class;

// Clean the src path first - remove Obsidian brackets if present
let cleanSrc = src;
if (!cleanSrc) {
  console.warn('ImageWrapper: src is undefined');
  cleanSrc = '';
}
if (cleanSrc.startsWith('[[') && cleanSrc.endsWith(']]')) {
  cleanSrc = cleanSrc.slice(2, -2);
}

// --- 核心修正区域开始：确保外部 URL 优先级最高 ---

// 1. 检查是否为外部 URL 或 Data URI
const isExternal = cleanSrc.startsWith("http") || cleanSrc.startsWith("https") || cleanSrc.startsWith("data:");

// 2. 检查是否为同步文件夹（内容附件）内的相对路径
// isSyncedFolder 检查是否处于一个内容文件夹内，而不是全局附件文件夹
const isSyncedFolder = basePath && basePath.includes('/') && !basePath.endsWith('/attachments/');

// 3. 确定是否为需要 Astro 优化的本地图片 (相对路径)
// 只有当它不是外部链接，并且：
//    - 它不以 '/' 开头 (不是 /public 根目录下的公共图片) 
//    - 或者它是一个同步文件夹内的相对路径
const isLocal = !isExternal && (
  !cleanSrc.startsWith("/") || isSyncedFolder
); 

// 4. 确定是否为 /public 根目录下的公共图片 (以 '/' 开头, 但不需要优化)
const isPublic = cleanSrc.startsWith("/") && !isLocal && !isExternal;

// --- 核心修正区域结束 ---

// Dynamic import for local images
let img: any = null;
let isImageMissing = false;
let originalWidth: number | undefined = width;
let originalHeight: number | undefined = height;

if (isLocal) {
  try {
    // 使用 import.meta.glob 导入本地图片进行优化
    const files = import.meta.glob<ImageMetadata>("/public/**", {
      import: "default",
    });
    
    // --- 路径规范化逻辑 (保持不变) ---
    if (cleanSrc.startsWith('./')) {
      cleanSrc = cleanSrc.slice(2);
    }
    
    if (cleanSrc.startsWith('images/') && (basePath === '/posts/attachments/' || basePath === '/projects/attachments/' || basePath === '/docs/attachments/')) {
      cleanSrc = cleanSrc.slice(7);
    }
    
    if (cleanSrc.startsWith('images/') && basePath.includes('/attachments/') && basePath !== '/posts/attachments/' && basePath !== '/projects/attachments/' && basePath !== '/docs/attachments/') {
      cleanSrc = cleanSrc.slice(7);
    }
    
    if (cleanSrc.startsWith('attachments/') && basePath.includes('/projects/') && !basePath.includes('/attachments/')) {
      cleanSrc = cleanSrc.slice(12);
    }
    
    if (cleanSrc.startsWith('attachments/') && basePath === '/projects/attachments/') {
      cleanSrc = cleanSrc.slice(12);
    }
    
    // 规范化路径用于 glob 查找
    let normalizedPath = path
      .normalize(path.join("/public", basePath, cleanSrc))
      .replace(/\\/g, "/");
    
    if (!normalizedPath.startsWith("/public")) {
      normalizedPath = `/public${normalizedPath}`;
    }
    // --- 路径规范化逻辑 (结束) ---
    
    const file = files[normalizedPath];
    if (file) {
      img = await file();
      if (!originalWidth) originalWidth = img.width;
      if (!originalHeight) originalHeight = img.height;
    } else {
      isImageMissing = true;
    }
  } catch (error) {
    isImageMissing = true;
  }
}

// 计算最终宽高和样式 (保持不变)
let finalWidth = originalWidth;
let finalHeight = originalHeight;
let containerClass = "overflow-hidden relative";
let imageClass = "w-full h-auto";

if (aspectRatio !== "auto") {
  imageClass = "w-full h-full object-cover";
  
  switch (aspectRatio) {
    case "16:9":
      containerClass += " aspect-video";
      break;
    case "9:16":
      containerClass += " aspect-[9/16]";
      break;
    case "4:3":
      containerClass += " aspect-[4/3]";
      break;
    case "3:4":
      containerClass += " aspect-[3/4]";
      break;
    case "1:1":
      containerClass += " aspect-square";
      break;
  }
} else {
  if (originalWidth && originalHeight) {
    const ratio = originalWidth / originalHeight;
    if (ratio > 1.5) {
      imageClass = "w-full h-auto object-contain max-w-full";
    } else if (ratio < 0.67) {
      imageClass = "h-full w-auto object-contain max-h-full mx-auto";
    } else {
      imageClass = "w-full h-full object-cover";
      containerClass += " aspect-square";
    }
  } else {
    imageClass = "w-full h-auto object-contain";
  }
}

if (maxWidth) {
  containerClass += ` max-w-[${maxWidth}px] mx-auto`;
}

const imageStyle = `object-position: ${position}`;
---

<div id={id} class:list={[className, containerClass]}>
  {(isLocal && img) ? (
    <Image 
      src={img} 
      alt={alt} 
      width={finalWidth}
      height={finalHeight}
      format={format}
      quality={quality}
      class={imageClass} 
      style={imageStyle}
      loading={loading}
      decoding={decoding}
      fetchpriority={fetchpriority}
      densities={densities}
    />
  ) : (isPublic || isExternal) ? (
    <img 
      src={cleanSrc} 
      alt={alt} 
      class={imageClass} 
      style={imageStyle}
      loading={loading}
      decoding={decoding}
      fetchpriority={fetchpriority}
      width={finalWidth}
      height={finalHeight}
      {...isPublic ? {} : {referrerpolicy: 'no-referrer'}} />
  ) : isImageMissing ? (
    null
  ) : (
    <img 
      src={cleanSrc} 
      alt={alt} 
      class={imageClass} 
      style={imageStyle}
      loading={loading}
      decoding={decoding}
      fetchpriority={fetchpriority}
      width={finalWidth}
      height={finalHeight}
      referrerpolicy="no-referrer"
    />
  )}
  
  {caption && (
    <figcaption class="mt-2 text-sm text-primary-600 dark:text-primary-400 text-center italic">
      {caption}
    </figcaption>
  )}
</div>

<style>
/* 确保自定义宽高比样式生效 */
.aspect-\[9\/16\] {
  aspect-ratio: 9/16;
}
.aspect-\[4\/3\] {
  aspect-ratio: 4/3;
}
.aspect-\[3\/4\] {
  aspect-ratio: 3/4;
}
</style>
